---
// --- 1. TYPE DEFINITIONS & DATA ---
interface TimelineEvent {
    title: string;
    subtitle?: string;
    start: string; // YYYY-MM
    end: string; // YYYY-MM or "Present"
    track: "education" | "experience" | "awards";
    color: string;
    details?: string[];
    depth?: number;
    textMarginTop?: number;
}

import fs from "node:fs";
import path from "node:path";

const csvPath = path.join(process.cwd(), "src/data/timeline.csv");
const csvFileContent = fs.readFileSync(csvPath, "utf-8");

// Simple CSV Parser handling quotes and pipes
const parseCSV = (content: string): TimelineEvent[] => {
    const lines = content.trim().split("\n");
    // Skip headers (line 0)

    return lines.slice(1).map((line) => {
        // Simple CSV split logic: Handles quoted fields containing commas
        // Does not handle escaped quotes inside quotes for simplicity (unless added)
        // RegEx to match:
        // 1. Quoted string: "..."
        // 2. Simple string: ... (until comma)
        const matches = [];
        let inQuote = false;
        let running = "";

        for (let i = 0; i < line.length; i++) {
            const char = line[i];

            // Handle quotes
            if (char === '"') {
                // Check if it is an escaped quote ("")
                if (inQuote && line[i + 1] === '"') {
                    running += '"';
                    i++; // Skip next quote
                } else {
                    inQuote = !inQuote; // Toggle quote state
                }
            }
            // Handle comma separator (only if not in quotes)
            else if (char === "," && !inQuote) {
                matches.push(running);
                running = "";
            }
            // Regular character
            else {
                running += char;
            }
        }
        matches.push(running); // Push the last value

        // Map matches to object properties
        // Order: title,subtitle,start,end,track,color,details,depth,textMarginTop
        return {
            title: matches[0],
            subtitle: matches[1] || undefined,
            start: matches[2],
            end: matches[3],
            track: matches[4] as any,
            color: matches[5],
            details: matches[6] ? matches[6].split("|") : undefined,
            depth: matches[7] ? parseInt(matches[7]) : undefined,
            textMarginTop: matches[8] ? parseInt(matches[8]) : undefined,
        };
    });
};

const events: TimelineEvent[] = parseCSV(csvFileContent);

// --- 2. CONFIGURATION & HELPERS ---
const CONFIG = {
    monthHeight: 18,
    depthIndent: 8,
    tracks: [
        { id: "education", label: "Education", col: 1 },
        { id: "experience", label: "Work Experience", col: 3 },
        { id: "awards", label: "Awards", col: 4 },
    ],
};

// --- 3. DYNAMIC DATE CALCULATION ---
const PRESENT_DATE = "2026-08";

const dateToMonthIdx = (d: string) => {
    const [y, m] = d.split("-").map(Number);
    return y * 12 + m;
};

// Find global min/max to set grid boundaries automatically
const allDates = events.flatMap((e) => [
    e.start,
    e.end === "Present" ? PRESENT_DATE : e.end,
]);

const minMonthIdx = Math.min(...allDates.map(dateToMonthIdx)) - 2;
const maxMonthIdx = Math.max(...allDates.map(dateToMonthIdx));
const totalGridRows = maxMonthIdx - minMonthIdx;

const getGridRow = (dateStr: string) => {
    let targetIdx;
    if (dateStr === "Present") targetIdx = maxMonthIdx;
    else targetIdx = dateToMonthIdx(dateStr);

    return maxMonthIdx - targetIdx + 1;
};

// Pre-calculate layout data
// Calculate minimum rows needed based on content (title only vs title + subtitle)
// Estimated heights: padding (8px) + pt-1 (4px) + title (~20px) + subtitle (~18px if present)
const titleOnlyHeight = 18; // ~32px for title-only entries
const titleSubtitleHeight = 36; // ~50px for entries with subtitle

const processedEvents = events.map((e) => {
    const startRow = getGridRow(e.end);
    let endRow = getGridRow(e.start) + 1;
    if (startRow >= endRow) endRow = startRow + 1;

    // Calculate content-dependent minimum row span
    const minHeight = e.subtitle ? titleSubtitleHeight : titleOnlyHeight;
    const minRowSpan = Math.ceil(minHeight / CONFIG.monthHeight);

    // Ensure the entry spans at least minRowSpan rows
    const currentSpan = endRow - startRow;
    if (currentSpan < minRowSpan) {
        endRow = startRow + minRowSpan;
    }

    return {
        ...e,
        gridRowStart: startRow,
        gridRowEnd: endRow,
        depth: e.depth || 0,
    };
});

// Generate Axis (Years/Months)
const axisItems = Array.from({ length: totalGridRows }, (_, i) => {
    const row = i + 1;
    const currentAbsMonth = maxMonthIdx - row + 1;
    return {
        row,
        year: Math.floor((currentAbsMonth - 1) / 12),
        month: ((currentAbsMonth - 1) % 12) + 1,
    };
}).filter((item) => item.month > 0);
---

<div class="relative w-full max-w-6xl mx-auto p-4 md:p-10" id="cv">
    <h2 class="text-3xl font-mono font-bold text-center mb-12">
        <span class="text-teal-400">./</span>timeline
    </h2>

    <!-- HEADER -->
    <div
        class="hidden md:grid gap-x-8 mb-2 sticky top-0 z-40 bg-slate-950"
        style="grid-template-columns: 1fr 60px 1fr 1fr;"
    >
        <div
            class="flex items-center justify-center font-mono font-bold text-slate-300 py-2 bg-slate-950/80 backdrop-blur rounded-t-lg"
        >
            Education
        </div>
        <div></div>
        <div
            class="flex items-center justify-center font-mono font-bold text-slate-300 py-2 bg-slate-950/80 backdrop-blur rounded-t-lg"
        >
            Work Experience
        </div>
        <div
            class="flex items-center justify-center font-mono font-bold text-slate-300 py-2 bg-slate-950/80 backdrop-blur rounded-t-lg"
        >
            Awards
        </div>
    </div>

    <!-- DESKTOP GRID -->
    <div
        class="hidden md:grid gap-x-8 relative"
        style={`grid-template-columns: 1fr 60px 1fr 1fr; grid-template-rows: repeat(${totalGridRows}, ${CONFIG.monthHeight}px);`}
    >
        <!-- AXIS COLUMN -->
        {
            axisItems.map((item, index) => {
                const isFirstMonth = item.month === 12 || item.row === 1;
                const isYearChange =
                    index > 0 && axisItems[index - 1].year !== item.year;

                return (
                    <>
                        {isYearChange && (
                            <div
                                class="border-t border-slate-700/50"
                                style={`grid-column: 1 / -1; grid-row: ${item.row}; z-index: 0;`}
                            />
                        )}
                        <div
                            class="flex items-center justify-center gap-2 font-mono text-slate-500 font-bold z-10"
                            style={`grid-column: 2; grid-row: ${item.row};`}
                        >
                            {isFirstMonth ? (
                                <span class="text-[11px] text-teal-400/80 leading-none min-w-[32px] text-right">
                                    {item.year}
                                </span>
                            ) : (
                                <span class="min-w-[32px]" />
                            )}
                            <span class="text-[10px] opacity-60 leading-none min-w-[16px]">
                                {String(item.month).padStart(2, "0")}
                            </span>
                        </div>
                    </>
                );
            })
        }

        <!-- EVENTS LOOP -->
        {
            processedEvents.map((e) => {
                const trackConfig = CONFIG.tracks.find((t) => t.id === e.track);
                if (!trackConfig) return null;

                const isPresent = e.end === "Present";
                const indent = e.depth * CONFIG.depthIndent;
                const zIndex = 10 + e.depth * 5;

                const gradientHeight = 2 * CONFIG.monthHeight;

                return (
                    <div
                        class={`timeline-card group relative rounded-lg border border-slate-700/50 px-3 py-1 min-h-fit hover:z-50 transition-all duration-300 hover:scale-[1.02] hover:shadow-[0_0_20px_rgba(0,0,0,0.5)] ${e.color} bg-opacity-20 backdrop-blur-sm hover:bg-opacity-90 cursor-pointer`}
                        style={`
                grid-column: ${trackConfig.col}; 
                grid-row: ${e.gridRowStart} / ${e.gridRowEnd}; 
                margin-left: ${indent}px; 
                margin-right: -${indent}px; 
                z-index: ${zIndex};
                ${isPresent ? `mask-image: linear-gradient(to bottom, transparent, black ${gradientHeight}px); -webkit-mask-image: linear-gradient(to bottom, transparent, black ${gradientHeight}px);` : ""}
            `}
                        data-json={JSON.stringify(e)}
                    >
                        <div
                            class="flex flex-col h-full pointer-events-none justify-start pt-1"
                            style={
                                e.textMarginTop && !isPresent
                                    ? `margin-top: ${e.textMarginTop}px`
                                    : ""
                            }
                        >
                            {isPresent && (
                                <div style={`height: ${gradientHeight}px`} />
                            )}
                            {e.track === "awards" ? (
                                <>
                                    <h3 class="font-bold text-xs md:text-sm text-slate-100 group-hover:text-white leading-tight">
                                        {e.title}
                                    </h3>
                                    {e.subtitle && (
                                        <p class="text-[10px] font-mono opacity-70 mt-0.5">
                                            {e.subtitle}
                                        </p>
                                    )}
                                </>
                            ) : (
                                <>
                                    <h3 class="font-bold text-slate-100 group-hover:text-white leading-tight">
                                        {e.title}
                                    </h3>
                                    {e.subtitle && (
                                        <p class="text-sm text-slate-300 group-hover:text-slate-100">
                                            {e.subtitle}
                                        </p>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                );
            })
        }
    </div>

    <!-- MOBILE LIST -->
    <div class="md:hidden space-y-6 border-l-2 border-slate-800 ml-3 pl-6">
        {
            processedEvents
                .sort((a, b) => a.gridRowStart - b.gridRowStart)
                .map((e) => (
                    <div
                        class="relative timeline-card cursor-pointer group"
                        data-json={JSON.stringify(e)}
                    >
                        <div
                            class={`absolute -left-[31px] top-2 w-4 h-4 rounded-full ${e.color}`}
                        />
                        <div
                            class={`p-4 rounded-lg bg-slate-900 border border-slate-800 ${e.color} bg-opacity-10 pointer-events-none`}
                        >
                            <span class="text-xs font-mono text-teal-400">
                                {e.start} - {e.end}
                            </span>
                            <h3 class="font-bold text-slate-100 mt-1">
                                {e.title}
                            </h3>
                            {e.subtitle && (
                                <p class="text-sm text-slate-400">
                                    {e.subtitle}
                                </p>
                            )}
                        </div>
                    </div>
                ))
        }
    </div>
</div>

<!-- MODAL -->
<div
    id="modal-backdrop"
    class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0"
    aria-hidden="true"
>
    <div
        id="modal-content"
        class="relative w-full max-w-lg bg-slate-900 border border-slate-700 rounded-xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0 overflow-hidden"
    >
        <div id="modal-header-color" class="h-3 w-full bg-slate-700"></div>
        <button
            id="modal-close"
            class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 rounded-full p-1 transition-colors z-10"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><line x1="18" y1="6" x2="6" y2="18"></line><line
                    x1="6"
                    y1="6"
                    x2="18"
                    y2="18"></line></svg
            >
        </button>
        <div class="p-6 pt-5">
            <span
                id="modal-date"
                class="block text-xs font-mono text-teal-400 mb-2"></span>
            <h3
                id="modal-title"
                class="text-2xl font-bold text-white mb-1 leading-tight pr-8"
            >
            </h3>
            <p id="modal-org" class="text-lg text-slate-300 mb-6"></p>
            <div class="bg-black/20 rounded-lg p-4 border border-slate-800/50">
                <h4
                    class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3"
                >
                    Key Details
                </h4>
                <ul
                    id="modal-details"
                    class="space-y-2 text-sm text-slate-300 list-disc list-inside"
                >
                </ul>
                <p
                    id="modal-no-details"
                    class="hidden text-sm text-slate-500 italic"
                >
                    No additional details available.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- MOUSE FOLLOWER TOOLTIP -->
<div
    id="timeline-tooltip"
    class="fixed z-50 pointer-events-none opacity-0 transition-opacity duration-150 ease-out hidden md:block"
    style="left: 0; top: 0;"
>
    <div
        class="bg-slate-950/90 backdrop-blur border border-slate-700/50 text-white text-xs font-mono px-3 py-1.5 rounded shadow-xl"
    >
        Click for more info
    </div>
</div>

<script>
    const container = document.getElementById("cv");
    const backdrop = document.getElementById("modal-backdrop");
    const content = document.getElementById("modal-content");
    const closeBtn = document.getElementById("modal-close");
    const tooltip = document.getElementById("timeline-tooltip");

    const els = {
        title: document.getElementById("modal-title"),
        subtitle: document.getElementById("modal-org"),
        date: document.getElementById("modal-date"),
        header: document.getElementById("modal-header-color"),
        list: document.getElementById("modal-details"),
        noDetails: document.getElementById("modal-no-details"),
    };

    function openModal(dataJson: string) {
        if (!backdrop || !content) return;
        const data = JSON.parse(dataJson);

        els.title!.innerText = data.title;
        els.subtitle!.innerText = data.subtitle || "";
        els.date!.innerText = `${data.start} - ${data.end}`;
        els.header!.className = `h-3 w-full ${data.color}`;

        els.list!.innerHTML = "";
        if (data.details && data.details.length) {
            els.list!.classList.remove("hidden");
            els.noDetails!.classList.add("hidden");
            els.list!.innerHTML = data.details
                .map((d: string) => `<li>${d}</li>`)
                .join("");
        } else {
            els.list!.classList.add("hidden");
            els.noDetails!.classList.remove("hidden");
        }

        backdrop.classList.remove("hidden");
        backdrop.setAttribute("aria-hidden", "false");

        requestAnimationFrame(() => {
            backdrop.classList.remove("opacity-0");
            content.classList.remove("scale-95", "opacity-0");
            content.classList.add("scale-100", "opacity-100");
        });
    }

    function closeModal() {
        if (!backdrop || !content) return;
        backdrop.classList.add("opacity-0");
        content.classList.remove("scale-100", "opacity-100");
        content.classList.add("scale-95", "opacity-0");
        backdrop.setAttribute("aria-hidden", "true");
        setTimeout(() => backdrop.classList.add("hidden"), 300);
    }

    container?.addEventListener("click", (e) => {
        const card = (e.target as Element).closest(".timeline-card");
        if (card && card instanceof HTMLElement && card.dataset.json) {
            openModal(card.dataset.json);
        }
    });

    // Tooltip Logic
    const cards = document.querySelectorAll(".timeline-card");
    cards.forEach((card) => {
        card.addEventListener("mouseenter", () => {
            if (tooltip) {
                tooltip.classList.remove("opacity-0");
            }
        });
        card.addEventListener("mouseleave", () => {
            if (tooltip) {
                tooltip.classList.add("opacity-0");
            }
        });
        card.addEventListener("mousemove", (e) => {
            if (tooltip) {
                // Add a small offset so it doesn't overlap the cursor
                const x = (e as MouseEvent).clientX + 15;
                const y = (e as MouseEvent).clientY - 15;
                tooltip.style.transform = `translate(${x}px, ${y}px)`;
            }
        });
    });

    closeBtn?.addEventListener("click", closeModal);
    backdrop?.addEventListener("click", (e) => {
        if (e.target === backdrop) closeModal();
    });
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
    });
</script>
